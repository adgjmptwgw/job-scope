# 画面詳細設計：求人検索画面 (Search Screen)

## 1. 概要
- **目的**: AI（Gemini）を活用した高度な自然文検索により、ユーザーの意図に合致する求人をWeb全体から検索・評価して表示する。
- **パス**: `/search`

## 2. 構成要素 (UI Components)

### 検索フォーム (AI Search Form)

#### 自然文検索条件 (Natural Language Search) - **必須項目**
- **入力形式**: Textarea（複数行テキスト入力）
- **プレースホルダー**: "例: リモートワーク可能で、ReactとTypeScriptを使った開発経験が3年以上ある企業の求人"
- **必須**: はい（赤いアスタリスク `*` で表示）
- **バリデーション**:
  - 空の場合、検索ボタン押下時にエラーメッセージを表示
  - エラーメッセージ: "AI検索を行うには、自然文検索条件を入力してください"
  - 入力開始でエラーメッセージは自動的にクリア
  - **エラー時の挙動**: 該当フィールドまで自動的にスクロールし、フォーカスを当てる（ユーザーが即座に入力できるようにする）
- **機能**:
  - ユーザーの曖昧な要望を自然文で受け付けるメイン入力
  - AI（Gemini）がこの文章を解析して検索意図を抽出
  - 最小高さ: 120px（4行相当）

#### 詳細フィルター (Optional Filters) - 任意項目
これらの項目は全て任意です。AIが自然文から自動抽出するため入力は必須ではありません。

##### 技術スタック (Tech Stack)
- **入力形式**: タグ入力（カンマ区切り）
- **機能**: 入力候補表示（React, TypeScript, Node.jsなど）
- **必須**: いいえ

##### 勤務地 (Location)
- **入力形式**: タグ入力（カンマ区切り）
- **機能**: 入力候補表示（東京都、大阪府など）
- **必須**: いいえ

##### 最低年収 (Minimum Salary)
- **入力形式**: 数値選択（スライダーまたはドロップダウン）
- **範囲**: 0〜2000万円
- **必須**: いいえ

##### 勤務形態 (Work Style)
- **入力形式**: チェックボックス（複数選択可）
- **選択肢**:
  - Full Remote（フルリモート）
  - Hybrid（ハイブリッド）
  - On-site（オンサイト）
- **必須**: いいえ

##### 除外条件 (Exclude Conditions)
- **入力形式**: テキスト入力
- **プレースホルダー**: "例: SES企業、残業が多い"
- **必須**: いいえ

### 検索ボタン (Submit Button)
- **ラベル**: "AI検索を実行" / "AI分析中..." (ローディング時)
- **状態**:
  - **有効**: 自然文検索条件が入力されている
  - **無効**: 実行中（`isSearching = true`）
  - **バリデーションエラー**: 自然文検索条件が空の場合

### 検索履歴 (Recent Searches)
- 過去の検索条件をバッジ形式で表示
- **クリック時の動作**: フォームに条件を復元するのみ（検索は実行しない）
- ユーザーが「AI検索実行」ボタンを押すまで検索は開始されない

### 検索結果一覧 (AI Results Grid)

#### AI解釈結果 (AISearchInsight)

コンポーネントファイル: [`src/components/search/AISearchInsight.tsx`](../../src/components/search/AISearchInsight.tsx)

検索結果の上部に表示される、AIの解釈結果サマリー。ユーザーにAIの思考過程を見せることで、検索結果への信頼感を高めます。

##### レイアウト

```
┌──────────────────────────────────────────────────────────────┐
│  ┌─────┐                                                     │
│  │ ✨ │  AI解釈結果                                         │
│  └─────┘  「東京でReactエンジニアとして年収600万以上の求人」  │
│                                                              │
│  ┌───────────┐ ┌─────────┐ ┌──────────────┐                  │
│  │ 📍 東京都 │ │ 💻 React │ │ 💰 年収600万〜│                  │
│  └───────────┘ └─────────┘ └──────────────┘                  │
│                                                              │
│  ─────────────────────────────────────────────────────────── │
│  AIが推測した条件:                                           │
│  ┌────────────────────┐ ┌─────────────┐                      │
│  │ 💼 フロントエンド  │ │ 🏢 スタートアップ│                  │
│  └────────────────────┘ └─────────────┘                      │
│                                                              │
│  10件の求人が見つかりました                                   │
└──────────────────────────────────────────────────────────────┘
```

##### 構成要素

| セクション | 内容 | スタイル |
|-----------|------|---------|
| アイコン | ✨ (Sparkles) | グラデーション背景（primary→accent）の角丸四角形 |
| タイトル | "AI解釈結果" | 太字 |
| サマリー文 | `search_intent_summary`の内容 | 通常テキスト |

##### 明示的条件（Explicit Conditions）

ユーザーが明示的に指定した条件をバッジで表示。

| 条件 | アイコン | バッジ色 | 表示例 |
|-----|---------|---------|-------|
| 勤務地 | 📍 (MapPin) | アクセントカラー（紫系） | "東京都" |
| スキル | 💻 (Code) | プライマリカラー（青系） | "React", "TypeScript" |
| 最低年収 | - | 成功カラー（緑系） | "年収600万円〜" |

##### 暗黙的条件（Implicit Conditions）

AIが文脈から推測した条件。表示条件がある場合のみセパレーター（破線）の下に表示。

| 条件 | アイコン | バッジ色 | 表示例 |
|-----|---------|---------|-------|
| 職種 | 💼 (Briefcase) | セカンダリ（グレー系） | "フロントエンドエンジニア" |
| 企業規模 | 🏢 (Building2) | セカンダリ（グレー系） | "スタートアップ", "大手企業" |
| 推定年収 | - | セカンダリ（グレー系） | "推定年収600万円〜"（明示的年収がない場合のみ） |

##### 結果件数

- 表示位置: カード下部
- フォーマット: "{件数}件の求人が見つかりました"
- スタイル: 小さめテキスト、ミュートカラー

##### アニメーション

- 出現時: フェードイン + 下からスライド（Framer Motion）

##### データ構造

```typescript
interface SearchIntent {
  explicit: {
    locations?: string[];      // 明示的な勤務地
    skills?: string[];         // 明示的なスキル
    min_salary?: number | null; // 明示的な最低年収
  };
  implicit: {
    role?: string;             // 推測された職種
    employment_type?: string[];// 推測された雇用形態
    min_salary?: number;       // 推測された最低年収
    company_size?: string[];   // 推測された企業規模
    nice_to_have?: string[];   // あると嬉しい条件
  };
  search_intent_summary: string; // AIによる要約文
}
```

---

#### AI求人カード (AIJobCard)

コンポーネントファイル: [`src/components/search/AIJobCard.tsx`](../../src/components/search/AIJobCard.tsx)

##### カードレイアウト

```
┌─────────────────────────────────────────────────────────┐
│  [タイトル]                               ┌────────┐   │
│  [企業名]                                 │ 4.2    │   │
│                                           │マッチ度│   │
│  📍 勤務地  💰 年収レンジ                 └────────┘   │
│                                                         │
│  [スキルバッジ] [スキルバッジ] [スキルバッジ]           │
│                                                         │
│  ✨ マッチ理由                                         │
│    ✅ 理由1                                            │
│    ✅ 理由2                                            │
│    ✅ 理由3                                            │
│                                                         │
│  ▼ 仕事の詳細を見る                                    │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 📋 業務内容                                     │   │
│  │ [求人の説明文]                                   │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 🏢 勤務形態                                     │   │
│  │ [リモート可] [フレックス]                        │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  [詳細を見る]                         [♡ お気に入り]   │
└─────────────────────────────────────────────────────────┘
```

##### ヘッダー部分

| 要素 | 仕様 |
|-----|------|
| タイトル | 求人タイトル（最大2行、超過時は省略） |
| 企業名 | 企業名を表示 |
| マッチ度スコア | **5.0点満点**のスコアを大きく表示。色は閾値で変化（4.5以上=緑、3.5以上=青、それ未満=グレー） |

##### 基本情報

| 要素 | アイコン | 表示例 |
|-----|---------|-------|
| 勤務地 | 📍 (MapPin) | "東京都" |
| 年収レンジ | 💰 (DollarSign) | "600万〜900万円" |

##### スキルバッジ

- 求人が求めるスキルをバッジ形式で表示
- 最大表示数: 制限なし（折り返し）
- スタイル: `Badge` コンポーネント（outline variant）

##### マッチ理由セクション

| 要素 | 仕様 |
|-----|------|
| ヘッダー | "✨ マッチ理由" |
| 理由リスト | 3件の理由を `✅` アイコン付きで表示 |
| 表示条件 | `match_reasons` 配列が存在する場合のみ表示 |

##### 折りたたみセクション（仕事の詳細）

**トリガーボタン:**
- 閉じた状態: "▼ 仕事の詳細を見る"
- 開いた状態: "▲ 仕事の詳細を閉じる"

**展開時の内容:**

| セクション | 内容 |
|-----------|------|
| 業務内容 | 求人の説明文（`description`）を表示 |
| 勤務形態 | 勤務形態バッジ（リモート可、フレックス等）を表示 |

##### フッター部分

| ボタン | 動作 |
|-------|------|
| 詳細を見る | 求人詳細画面（`/jobs/[id]`）へ遷移 |
| お気に入り | ハートアイコン。トグルでお気に入り登録/解除 |

##### アニメーション

- カード出現時: フェードイン + 下からスライド（Framer Motion）
- ホバー時: 上方向に4pxリフト
- 折りたたみセクション: 高さアニメーション + フェード

---

#### 検索結果の状態保持

詳細画面から検索画面に戻った際、検索結果を復元するために`sessionStorage`を使用。

- **有効期限**: 30分
- **保存データ**: 検索結果配列、検索意図、検索実行フラグ
- **詳細**: [`docs/detail-design/search-storage.md`](../detail-design/search-storage.md)

---

- **詳細を見るボタン**: クリックで求人詳細画面へ遷移（検索結果はsessionStorageで保持）
- **お気に入りボタン**: 気になる求人を保存。トグル動作。

## 3. 機能・ロジック (Logic)

### 検索プロセス (The AI Flow)
1. **Submit**: ユーザーが検索ボタンを押下。
2. **Auto Scroll**: 「AI分析中...」のローディング表示エリアまで自動的にスクロールし、ユーザーに処理の開始を明示する。
   - **実装仕様**: レンダリング完了待ち時間（300ms）を考慮し、ローディング要素の約200px上を目標に `window.scrollTo` でスムーズに移動する（ヘッダー考慮のオフセット）。
3. **API Call**: `GET /api/jobs?q=...` をコール。
4. **Loading**: 
   - AI処理（Stage 1〜3）に時間がかかる（数秒〜十数秒）ため、プログレスバーや「AIが分析中...」といったリッチなローディングを表示する。
   - ステップ表示（Creating Query → Searching → Validating & Evaluating...）で体感待ち時間を減らす。
5. **Render**: 結果（JSON）を受け取り、カード一覧を描画。

### エラーハンドリング
- **検索結果 0件**: 
  - AI検索・通常検索ともに結果が0件の場合のみ「条件に合う求人が見つかりませんでした」を表示。
  - **注意**: AI検索結果がある場合は、通常検索結果が0件でもエラーメッセージは表示しない。
- **AI検索失敗（レート制限・タイムアウト等）**:
  - Gemini APIの制限により検索が完了できない場合、赤いアラートバナーを表示する。
  - 表示内容: 「AI検索を完了できませんでした」という見出しと、具体的なエラー理由。
  - アイコン: `AlertCircle`を使用。
- **タイムアウト**:
  - API制限（2回のリトライ後）内でも時間がかかる場合があるため、適切なタイムアウト通知を行う。

## 4. データ要件 (Data Requirements)
- **Source**: Real-time AI Search Result (Not Database)
- **Schema**:
  - `id`: UUID (Temporary generated by backend)
  - `title`: string
  - `company`: { name, evaluation_summary, scores }
  - `match_reasons`: string[] (AI Generated)
  - `confidence`: number (0-100)
  - `source_url`: string (Link to Indeed/Green/etc.)

## 5. 遷移
- **詳細を見る**: 求人詳細画面へ（メタデータ引継ぎ）

