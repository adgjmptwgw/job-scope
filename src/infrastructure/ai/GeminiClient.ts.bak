import { 
  IGeminiClient, 
  SearchConditions, 
  CompanyEvaluation,
  TechEvaluation,
  UserConcernEvaluation,
  ConcernScore,
  IntegratedEvaluationResult,
  JobWithCompanyEvaluation
} from './IGeminiClient';
import { SearchIntent } from '../../domain/types/SearchIntent';

/**
 * Gemini API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
 * Stage 1 ã¯å®Ÿéš›ã®APIã‚’ä½¿ç”¨ã€Stage 2-4 ã¯ãƒ¢ãƒƒã‚¯å®Ÿè£…
 */
export class GeminiClient implements IGeminiClient {
  private apiKey: string;
  private baseUrl = 'https://generativelanguage.googleapis.com/v1beta';

  constructor(apiKey: string) {
    this.apiKey = apiKey;
  }

  /**
   * æ—¢å­˜ã®æ¤œç´¢ã‚¯ã‚¨ãƒªãƒ‘ãƒ¼ã‚¹ï¼ˆæ—§å®Ÿè£…ï¼‰
   */
  async parseSearchQuery(query: string): Promise<SearchConditions> {
    const prompt = this.buildSearchQueryPrompt(query);
    console.log('[Gemini] parseSearchQuery called with:', query);
    
    try {
      if (!this.apiKey) {
        console.error('[Gemini] API Key is missing!');
        return {};
      }

      console.log('[Gemini] Sending request to Google API...');
      const response = await this.generateContentWithRetry(prompt, 0.1, 1024);

      if (!response.ok) {
        const errorText = await response.text();
        console.error(`Gemini API Error Detail: ${errorText}`);
        throw new Error(`Gemini API error: ${response.statusText} (${response.status})`);
      }

      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '{}';
      
      const jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```/) || text.match(/\{[\s\S]*\}/);
      const jsonText = jsonMatch ? (jsonMatch[1] || jsonMatch[0]) : '{}';
      
      return JSON.parse(jsonText);
    } catch (error: any) {
      if (error.message?.includes('(429)')) {
        console.warn('[Gemini] Rate limit exceeded. Falling back to keyword search.');
      } else {
        console.error('Failed to parse search query:', error);
      }
      return {};
    }
  }

  /**
   * Stage 1: Chain-of-Thought ã‚’ä½¿ã£ãŸæ„å›³ç†è§£
   * å®Ÿéš›ã®Gemini APIã‚’å‘¼ã³å‡ºã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¤œç´¢æ„å›³ã‚’è§£æã™ã‚‹
   */
  async parseQueryWithCoT(query: string): Promise<SearchIntent> {
    // Stderrã«å‡ºåŠ›ã—ã¦ç¢ºå®Ÿã«Dockerãƒ­ã‚°ã«è¡¨ç¤º
    console.error('\n========================================');
    console.error('ğŸ§  [Stage 1] Chain-of-Thought æ„å›³ç†è§£');
    console.error('========================================');
    console.error('ğŸ“ å…¥åŠ›ã‚¯ã‚¨ãƒª:', query);
    
    const prompt = this.buildCoTPrompt(query);
    
    try {
      console.error('ğŸ”„ Gemini API ã‚’å‘¼ã³å‡ºã—ä¸­...');
      const response = await this.generateContentWithRetry(prompt, 0.2, 512);
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('âŒ Gemini API ã‚¨ãƒ©ãƒ¼:', errorText);
        throw new Error(`Gemini API error: ${response.statusText} (${response.status})`);
      }
      
      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '{}';
      
      console.error('\nğŸ“¤ Gemini ç”Ÿãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›:');
      console.error('---');
      console.error(text);
      console.error('---');
      
      // ç©ºãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒã‚§ãƒƒã‚¯
      if (!text || text.trim() === '{}' || text.trim() === '') {
        console.error('âš ï¸ Gemini APIãŒç©ºã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã¾ã—ãŸ');
        throw new Error('Gemini API returned empty response');
      }
      
      // JSONéƒ¨åˆ†ã‚’æŠ½å‡º
      const jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```/) || text.match(/\{[\s\S]*\}/);
      const jsonText = jsonMatch ? (jsonMatch[1] || jsonMatch[0]) : null;
      
      if (!jsonText) {
        console.error('âŒ JSONãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', text.substring(0, 200));
        throw new Error('No valid JSON found in response');
      }
      
      const parsed = JSON.parse(jsonText);
      
      console.error('\nâœ… ãƒ‘ãƒ¼ã‚¹çµæœ:');
      console.error(JSON.stringify(parsed, null, 2));
      console.error('========================================\n');
      
      return {
        explicit: parsed.explicit || {
          locations: [],
          skills: [],
          min_salary: null
        },
        implicit: parsed.implicit || {
          role: undefined,
          employment_type: [],
          min_salary: null,
          company_size: [],
          nice_to_have: [],
          must_have: []
        },
        search_intent_summary: parsed.search_intent_summary || `ã€Œ${query}ã€ã®æ¤œç´¢çµæœ`
      };
    } catch (error: any) {
      console.error('âŒ [Stage 1] æ„å›³ç†è§£ã‚¨ãƒ©ãƒ¼:', error.message);
      throw error; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã›ãšã«ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹
    }
  }

  /**
   * Stage 2: Google Search Grounding ã‚’ä½¿ã£ãŸæ±‚äººæ¤œç´¢
   * Gemini APIã®Google Search Groundingæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦å®Ÿéš›ã®æ±‚äººæƒ…å ±ã‚’æ¤œç´¢ã™ã‚‹
   */
  async searchWithGrounding(query: string): Promise<any[]> {
    console.error('\n========================================');
    console.error('ğŸ” [Stage 2] Google Search Grounding');
    console.error('========================================');
    console.error('ğŸ“ æ¤œç´¢ã‚¯ã‚¨ãƒª:', query);
    
    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: æ¤œç´¢çµæœã«åŸºã¥ã„ã¦JSONã‚’ç”Ÿæˆã™ã‚‹ã‚ˆã†æŒ‡ç¤º
    const prompt = `ã‚ãªãŸã¯æ±‚äººæ¤œç´¢ã®å°‚é–€å®¶ã§ã™ã€‚Googleæ¤œç´¢ã‚’æ´»ç”¨ã—ã¦ã€å®Ÿåœ¨ã™ã‚‹æœ€æ–°ã®æ±‚äººæƒ…å ±ã‚’æ¢ã—ã¦ãã ã•ã„ã€‚
ä»¥ä¸‹ã®æ¡ä»¶ã«åˆã†æ—¥æœ¬ã®IT/Webç³»æ±‚äººã‚’æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚

ã€æ¤œç´¢æ¡ä»¶ã€‘
${query}

ã€æŒ‡ç¤ºã€‘
1. æ¤œç´¢ã§è¦‹ã¤ã‹ã£ãŸå®Ÿéš›ã®æ±‚äººæƒ…å ±ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚æ¶ç©ºã®æ±‚äººã¯ä½œæˆã—ãªã„ã§ãã ã•ã„ã€‚
2. ä»¥ä¸‹ã®JSONå½¢å¼ã§æœ€å¤§5ä»¶å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
\`\`\`json
{
  "jobs": [
    {
      "title": "è·ç¨®å",
      "company": "ä¼æ¥­å",
      "location": "å‹¤å‹™åœ°",
      "salary_min": å¹´åä¸‹é™(æ•°å€¤ã¾ãŸã¯0),
      "salary_max": å¹´åä¸Šé™(æ•°å€¤ã¾ãŸã¯0),
      "skills": ["å¿…è¦ã‚¹ã‚­ãƒ«"],
      "source_url": "æ±‚äººãƒšãƒ¼ã‚¸ã®URL",
      "description": "æ±‚äººã®è¦ç´„"
    }
  ]
}
\`\`\`
`;

    try {
      console.error('ğŸ”„ Gemini API (with Grounding) ã‚’å‘¼ã³å‡ºã—ä¸­...');
      
      // Groundingãƒ„ãƒ¼ãƒ«ã‚’æœ‰åŠ¹ã«ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
      const response = await this.generateContentWithRetry(prompt, 0.3, 4096, true);
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('âŒ Gemini API ã‚¨ãƒ©ãƒ¼:', errorText);
        throw new Error(`Gemini API error: ${response.statusText} (${response.status})`);
      }
      
      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '{}';
      
      console.error('\nğŸ“¤ Gemini å‡ºåŠ›:');
      console.error('---');
      console.error(text.substring(0, 500) + '...');
      console.error('---');
      
      // ã‚°ãƒ©ã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ã‚°ï¼ˆæ¤œç´¢ã‚¯ã‚¨ãƒªã‚„å‚ç…§å…ƒãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
      const groundingMetadata = data.candidates?.[0]?.groundingMetadata;
      if (groundingMetadata) {
        console.error('\nğŸŒ ã‚°ãƒ©ã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°æƒ…å ±:');
        console.error('Webæ¤œç´¢ã‚¯ã‚¨ãƒª:', groundingMetadata.webSearchQueries || []);
        console.error('å‚ç…§ãƒãƒ£ãƒ³ã‚¯æ•°:', groundingMetadata.groundingChunks?.length || 0);
      } else {
        console.warn('âš ï¸ ã‚°ãƒ©ã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ (æ¤œç´¢ãŒå®Ÿè¡Œã•ã‚Œãªã‹ã£ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™)');
      }
      
      // JSONéƒ¨åˆ†ã‚’æŠ½å‡º
      const jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```/) || text.match(/\{[\s\S]*\}/);
      const jsonText = jsonMatch ? (jsonMatch[1] || jsonMatch[0]) : '{"jobs":[]}';
      
      let parsed;
      const jobs = parsed.jobs || [];
      
      // çµæœã®æ•´å½¢
      const results = jobs.map((job: any, idx: number) => ({
        id: `grounding-job-${idx + 1}`,
        title: job.title || 'ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜',
        company: { name: job.company || 'ä¼æ¥­åä¸æ˜' },
        location: job.location || 'å‹¤å‹™åœ°ä¸æ˜',
        salary_min: typeof job.salary_min === 'number' ? job.salary_min : 0,
        salary_max: typeof job.salary_max === 'number' ? job.salary_max : 0,
        skills: Array.isArray(job.skills) ? job.skills : [],
        source_url: job.source_url || '',
        description: job.description || 'è©³ç´°ãªã—'
      }));
      
      console.error(`\nâœ… ${results.length}ä»¶ã®æ±‚äººã‚’å–å¾— (Grounding)`);
      console.error('========================================\n');
      return results;
      
    } catch (error: any) {
      console.error('âŒ [Stage 2] Groundingæ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error.message);
      // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç©ºé…åˆ—ã‚’è¿”ã—ã¦ã€å¾Œç¶šã®å‡¦ç†ã§ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã•ã›ã‚‹
      return []; 
    }
  }

  /**
   * Stage 3: Self-Consistency ã«ã‚ˆã‚‹æ¤œè¨¼
   * å®Ÿéš›ã® Gemini API ã‚’ä½¿ç”¨ã—ã¦æ±‚äººå€™è£œã‚’3ã¤ã®ç•°ãªã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§è©•ä¾¡ã—ã€
   * å¤šæ•°æ±ºã«ã‚ˆã‚Šä¸€è²«æ€§ã‚’æ¤œè¨¼ã™ã‚‹ã€‚
   */
  async evaluateConsistencyBatch(candidates: any[], intent: SearchIntent): Promise<any[]> {
    console.error('\n========================================');
    console.error('âœ“ [Stage 3] Self-Consistency æ¤œè¨¼');
    console.error('========================================');
    console.error('ğŸ“Š å€™è£œæ•°:', candidates.length);
    console.error('ğŸ¯ æ„å›³:', intent.search_intent_summary);

    const validatedCandidates: any[] = [];
    
    for (const candidate of candidates) {
      console.error(`\nğŸ” æ±‚äººè©•ä¾¡ä¸­: ${candidate.title} @ ${candidate.company.name}`);
      
      // 3ã¤ã®ç•°ãªã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§è©•ä¾¡ï¼ˆã“ã“ã‚‚ç›´åˆ—ã«ã—ã¦ã‚ˆã‚Šå®‰å…¨ã«ï¼‰
      const prompts = [
        this.buildDirectScoringPrompt(candidate, intent),
        this.buildRequirementCheckPrompt(candidate, intent),
        this.buildCriticalReviewPrompt(candidate, intent)
      ];

      try {
        const results = [];
        for (const prompt of prompts) {
          const response = await this.generateContentWithRetry(prompt, 0.3, 1024);
          if (!response.ok) {
            results.push({ score: 0, isMatch: false, reason: 'API Error' });
            continue;
          }

          const data = await response.json();
          const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '{}';
          
          // JSON ãƒ‘ãƒ¼ã‚¹
          const jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```/) || text.match(/\{[\s\S]*\}/);
          const jsonText = jsonMatch ? (jsonMatch[1] || jsonMatch[0]) : '{}';
          const parsed = JSON.parse(jsonText);

          results.push({
            score: parsed.score || 0,
            isMatch: (parsed.score || 0) >= 70,
            reason: parsed.reason || ''
          });
          
          // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé–“ã«2ç§’å¾…æ©Ÿã—ã¦ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’å›é¿
          await this.sleep(2000);
        }

        // å¤šæ•°æ±ºã¨å¹³å‡å€¤ã®ç®—å‡º
        const matchCount = results.filter(r => r.isMatch).length;
        const avgScore = Math.round(results.reduce((sum, r) => sum + r.score, 0) / results.length);
        const isFinalMatch = matchCount >= 2;
        
        // ç†ç”±ã®çµ±åˆ
        const matchReasons = results
          .filter(r => r.reason)
          .map(r => `âœ… ${r.reason}`)
          .slice(0, 3);

        console.error(`  => çµæœ: ${isFinalMatch ? 'ä¸€è‡´' : 'ä¸ä¸€è‡´'} (ã‚¹ã‚³ã‚¢: ${avgScore}, ä¸€è‡´æ•°: ${matchCount}/3)`);

        validatedCandidates.push({
          ...candidate,
          confidence: Math.round((matchCount / 3) * 100),
          match_score: avgScore,
          is_match: isFinalMatch,
          match_reasons: matchReasons.length > 0 ? matchReasons : ['æ¡ä»¶ã«åˆè‡´ã—ã¦ã„ã¾ã™']
        });
        
        // æ±‚äººé–“ã«4ç§’å¾…æ©Ÿï¼ˆ15RPMåˆ¶é™ã‚’ç¢ºå®Ÿã«å®ˆã‚‹ãŸã‚ï¼‰
        await this.sleep(4000);

      } catch (error: any) {
        console.error(`  âŒ è©•ä¾¡ã‚¨ãƒ©ãƒ¼ (${candidate.title}):`, error.message);
        validatedCandidates.push({
          ...candidate,
          confidence: 0,
          match_score: 0,
          is_match: false,
          match_reasons: ['è©•ä¾¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ']
        });
      }
    }

    // ãƒãƒƒãƒã—ãŸã‚‚ã®ã ã‘ã‚’è¿”ã™ï¼ˆã¾ãŸã¯ã‚¹ã‚³ã‚¢é †ã«ã‚½ãƒ¼ãƒˆã—ã¦å…¨ã¦è¿”ã™ã‹æ¤œè¨ãŒå¿…è¦ã ãŒã€
    // ã“ã“ã§ã¯ãƒãƒƒãƒã—ãŸã‚‚ã®ã‚’å„ªå…ˆã—ã¦è¿”ã™ï¼‰
    const results = validatedCandidates
      .filter(c => c.is_match)
      .sort((a, b) => b.match_score - a.match_score);

    console.error(`\nâœ… æ¤œè¨¼å®Œäº†: ${results.length}/${candidates.length} ä»¶ãŒé©åˆ`);
    console.error('========================================\n');
    
    return results;
  }

  /**
   * ãƒ‘ã‚¿ãƒ¼ãƒ³1: ç›´æ¥çš„ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
   */
  private buildDirectScoringPrompt(job: any, intent: SearchIntent): string {
    return `ã‚ãªãŸã¯å„ªç§€ãªITãƒªã‚¯ãƒ«ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚
ä»¥ä¸‹ã®æ±‚äººãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¤œç´¢æ„å›³ã«ã©ã®ç¨‹åº¦åˆè‡´ã—ã¦ã„ã‚‹ã‹ã€0-100ç‚¹ã§è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¤œç´¢æ„å›³ã€‘
${intent.search_intent_summary}

ã€æ±‚äººæƒ…å ±ã€‘
ã‚¿ã‚¤ãƒˆãƒ«: ${job.title}
ä¼æ¥­: ${job.company.name}
å‹¤å‹™åœ°: ${job.location}
å¿…é ˆã‚¹ã‚­ãƒ«: ${job.skills.join(', ')}
çµ¦ä¸: ${job.salary_min} - ${job.salary_max}
èª¬æ˜: ${job.description}

ã€å‡ºåŠ›å½¢å¼ã€‘
JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
{
  "score": 0-100ã®æ•°å€¤,
  "reason": "åˆè‡´ã¾ãŸã¯ä¸åˆè‡´ã®ä¸»ãªç†ç”±ï¼ˆ1æ–‡ï¼‰"
}

ã€å‡ºåŠ›åˆ¶ç´„ - å³å®ˆã€‘
- JSONã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„
- ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®å›²ã„ã¯ä¸è¦ã§ã™
- èª¬æ˜æ–‡ã€å‰ç½®ãã€å¾Œç½®ãã¯ä¸€åˆ‡ä¸è¦ã§ã™`;
  }

  /**
   * ãƒ‘ã‚¿ãƒ¼ãƒ³2: è¦ä»¶ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
   */
  private buildRequirementCheckPrompt(job: any, intent: SearchIntent): string {
    const mustHave = intent.implicit?.must_have || [];
    const explicitSkills = intent.explicit?.skills || [];
    const allRequirements = [...new Set([...mustHave, ...explicitSkills])];

    return `ã‚ãªãŸã¯å³æ ¼ãªæ¡ç”¨å¯©æŸ»å“¡ã§ã™ã€‚
ä»¥ä¸‹ã®æ±‚äººãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã€Œå¿…é ˆæ¡ä»¶ã€ã‚’ã™ã¹ã¦æº€ãŸã—ã¦ã„ã‚‹ã‹å³ã—ããƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚

ã€å¿…é ˆæ¡ä»¶ã€‘
- ã‚¹ã‚­ãƒ«/è¦ä»¶: ${allRequirements.join(', ')}
- å‹¤å‹™åœ°: ${intent.explicit?.locations?.join(', ') || 'æŒ‡å®šãªã—'}
- æœ€ä½å¹´å: ${intent.explicit?.min_salary || 'æŒ‡å®šãªã—'}

ã€æ±‚äººæƒ…å ±ã€‘
${JSON.stringify(job)}

ã€æŒ‡ç¤ºã€‘
ã™ã¹ã¦ã®æ¡ä»¶ã‚’ç…§ã‚‰ã—åˆã‚ã›ã€ç·åˆçš„ãªé©åˆã‚¹ã‚³ã‚¢ï¼ˆ0-100ï¼‰ã‚’ç®—å‡ºã—ã¦ãã ã•ã„ã€‚
å¿…é ˆæ¡ä»¶ãŒå¤§å¹…ã«æ¬ ã‘ã¦ã„ã‚‹å ´åˆã¯50ç‚¹ä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚

ã€å‡ºåŠ›å½¢å¼ã€‘
JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
{
  "score": 0-100ã®æ•°å€¤,
  "reason": "è¦ä»¶ã¸ã®é©åˆçŠ¶æ³ï¼ˆ1æ–‡ï¼‰"
}

ã€å‡ºåŠ›åˆ¶ç´„ - å³å®ˆã€‘
- JSONã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„
- ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®å›²ã„ã¯ä¸è¦ã§ã™
- èª¬æ˜æ–‡ã€å‰ç½®ãã€å¾Œç½®ãã¯ä¸€åˆ‡ä¸è¦ã§ã™`;
  }

  /**
   * ãƒ‘ã‚¿ãƒ¼ãƒ³3: æ‰¹åˆ¤çš„æ¤œè¨¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
   */
  private buildCriticalReviewPrompt(job: any, intent: SearchIntent): string {
    return `ã‚ãªãŸã¯æ…é‡ãªã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ã“ã®æ±‚äººã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å‹§ã‚ã‚‹ä¸Šã§ã®ã€Œãƒªã‚¹ã‚¯ã€ã‚„ã€ŒãƒŸã‚¹ãƒãƒƒãƒã€ã®å¯èƒ½æ€§ã‚’ã‚ãˆã¦æ¢ã—ã¦ãã ã•ã„ã€‚

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¸Œæœ›ã€‘
${intent.search_intent_summary}

ã€æ±‚äººæƒ…å ±ã€‘
${JSON.stringify(job)}

ã€æŒ‡ç¤ºã€‘
ãƒã‚¬ãƒ†ã‚£ãƒ–ãªè¦ç´ ï¼ˆæ¡ä»¶ãŒæ›–æ˜§ã€ã‚¹ã‚­ãƒ«ãŒå¾®å¦™ã«ã‚ºãƒ¬ã¦ã„ã‚‹ã€å¹´åãŒå¸Œæœ›ã«å±Šã‹ãªã„ç­‰ï¼‰ãŒãªã„ã‹åˆ†æã—ã€
ãã‚Œã§ã‚‚ãªãŠå‹§ã‚ã‚‹ä¾¡å€¤ãŒã‚ã‚‹ã‹ã‚’åˆ¤æ–­ã—ã¦0-100ç‚¹ã§ã‚¹ã‚³ã‚¢ã‚’ä»˜ã‘ã¦ãã ã•ã„ã€‚

ã€å‡ºåŠ›å½¢å¼ã€‘
JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
{
  "score": 0-100ã®æ•°å€¤,
  "reason": "åˆ†æçµæœï¼ˆ1æ–‡ï¼‰"
}

ã€å‡ºåŠ›åˆ¶ç´„ - å³å®ˆã€‘
- JSONã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„
- ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®å›²ã„ã¯ä¸è¦ã§ã™
- èª¬æ˜æ–‡ã€å‰ç½®ãã€å¾Œç½®ãã¯ä¸€åˆ‡ä¸è¦ã§ã™`;
  }

  /**
   * Stage 4: ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢å¿ƒäº‹é …ã«åŸºã¥ãä¼æ¥­è©•ä¾¡
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¤œç´¢æ¡ä»¶ã‹ã‚‰æŠ½å‡ºã—ãŸé–¢å¿ƒäº‹é …ã«ã¤ã„ã¦ã€ä¼æ¥­ã‚’è©•ä¾¡ã™ã‚‹
   */
  async evaluateCompaniesForUserConcerns(
    companyNames: string[],
    intent: SearchIntent
  ): Promise<UserConcernEvaluation[]> {
    console.error('\n========================================');
    console.error('ğŸ¢ [Stage 4] ãƒ¦ãƒ¼ã‚¶ãƒ¼æ„å›³ã«åŸºã¥ãä¼æ¥­è©•ä¾¡');
    console.error('========================================');
    console.error('ğŸ“Š å¯¾è±¡ä¼æ¥­:', companyNames.join(', '));
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é–¢å¿ƒäº‹é …ã‚’æŠ½å‡º
    const concerns = this.extractUserConcerns(intent);
    console.error('ğŸ¯ è©•ä¾¡ã™ã‚‹é–¢å¿ƒäº‹é …:', concerns.join(', '));
    
    const results: UserConcernEvaluation[] = [];
    
    for (const companyName of companyNames) {
      console.error(`\nğŸ” ä¼æ¥­è©•ä¾¡ä¸­: ${companyName}`);
      
      try {
        // 2ã¤ã®ç•°ãªã‚‹è¦³ç‚¹ã‹ã‚‰è©•ä¾¡
        const [directEval, criticalEval] = await Promise.all([
          this.evaluateCompanyDirect(companyName, concerns),
          this.evaluateCompanyCritical(companyName, concerns)
        ]);
        
        // çµæœã‚’çµ±åˆ
        const concernsMap: Record<string, ConcernScore> = {};
        let totalScore = 0;
        
        for (const concern of concerns) {
          const directScore = directEval[concern]?.score || 50;
          const criticalScore = criticalEval[concern]?.score || 50;
          const avgScore = Math.round((directScore + criticalScore) / 2);
          
          concernsMap[concern] = {
            concern,
            score: avgScore,
            summary: directEval[concern]?.summary || 'è©•ä¾¡æƒ…å ±ãªã—',
            sources: directEval[concern]?.sources || []
          };
          
          totalScore += avgScore;
        }
        
        const overall_score = concerns.length > 0 
          ? Math.round(totalScore / concerns.length) 
          : 0;
        
        results.push({
          companyName,
          concerns: concernsMap,
          overall_score
        });
        
        console.error(`  âœ… è©•ä¾¡å®Œäº† (ç·åˆã‚¹ã‚³ã‚¢: ${overall_score})`);
        
        // ä¼æ¥­é–“ã«3ç§’å¾…æ©Ÿï¼ˆ2å›è©•ä¾¡Ã—ä¼æ¥­æ•°ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–ï¼‰
        await this.sleep(3000);
        
      } catch (error: any) {
        console.error(`  âŒ è©•ä¾¡ã‚¨ãƒ©ãƒ¼ (${companyName}):`, error.message);
        
        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè©•ä¾¡
        const defaultConcerns: Record<string, ConcernScore> = {};
        concerns.forEach(c => {
          defaultConcerns[c] = {
            concern: c,
            score: 0,
            summary: 'è©•ä¾¡æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ',
            sources: []
          };
        });
        
        results.push({
          companyName,
          concerns: defaultConcerns,
          overall_score: 0
        });
      }
    }
    
    console.error(`\nâœ… ä¼æ¥­è©•ä¾¡å®Œäº†: ${results.length}/${companyNames.length} ä»¶`);
    console.error('========================================\n');
    
    return results;
  }
  
  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é–¢å¿ƒäº‹é …ã‚’æŠ½å‡º
   */
  private extractUserConcerns(intent: SearchIntent): string[] {
    const concerns: string[] = [];
    
    // implicitæ¡ä»¶ã‹ã‚‰é–¢å¿ƒäº‹é …ã‚’æŠ½å‡º
    if (intent.implicit?.must_have) {
      concerns.push(...intent.implicit.must_have);
    }
    
    if (intent.implicit?.nice_to_have) {
      concerns.push(...intent.implicit.nice_to_have);
    }
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆæ¡ä»¶ãŒãªã„å ´åˆï¼‰
    if (concerns.length === 0) {
      concerns.push('æŠ€è¡“åŠ›', 'åƒãã‚„ã™ã•', 'æˆé•·æ©Ÿä¼š');
    }
    
    // é‡è¤‡å‰Šé™¤ & æœ€å¤§5ã¤ã¾ã§
    return [...new Set(concerns)].slice(0, 5);
  }
  
  /**
   * ç›´æ¥çš„ãªè©•ä¾¡
   */
  private async evaluateCompanyDirect(
    companyName: string,
    concerns: string[]
  ): Promise<Record<string, { score: number; summary: string; sources: string[] }>> {
    const prompt = this.buildDirectEvaluationPrompt(companyName, concerns);
    
    try {
      const response = await this.generateContentWithRetry(prompt, 0.3, 1024);
      
      if (!response.ok) {
        return this.getDefaultConcernEvaluation(concerns);
      }
      
      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '{}';
      
      const jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```/) || text.match(/\{[\s\S]*\}/);
      const jsonText = jsonMatch ? (jsonMatch[1] || jsonMatch[0]) : '{}';
      
      const parsed = JSON.parse(jsonText);
      return parsed.concerns || this.getDefaultConcernEvaluation(concerns);
      
    } catch (error: any) {
      console.warn(`  âš ï¸ ç›´æ¥è©•ä¾¡ã‚¨ãƒ©ãƒ¼:`, error.message);
      return this.getDefaultConcernEvaluation(concerns);
    }
  }
  
  /**
   * æ‰¹åˆ¤çš„ãªæ¤œè¨¼
   */
  private async evaluateCompanyCritical(
    companyName: string,
    concerns: string[]
  ): Promise<Record<string, { score: number; summary: string; sources: string[] }>> {
    const prompt = this.buildCriticalEvaluationPrompt(companyName, concerns);
    
    try {
      const response = await this.generateContentWithRetry(prompt, 0.3, 2048);
      
      if (!response.ok) {
        return this.getDefaultConcernEvaluation(concerns);
      }
      
      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '{}';
      
      const jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```/) || text.match(/\{[\s\S]*\}/);
      const jsonText = jsonMatch ? (jsonMatch[1] || jsonMatch[0]) : '{}';
      
      const parsed = JSON.parse(jsonText);
      return parsed.concerns || this.getDefaultConcernEvaluation(concerns);
      
    } catch (error: any) {
      console.warn(`  âš ï¸ æ‰¹åˆ¤çš„æ¤œè¨¼ã‚¨ãƒ©ãƒ¼:`, error.message);
      return this.getDefaultConcernEvaluation(concerns);
    }
  }
  
  /**
   * ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é–¢å¿ƒäº‹é …è©•ä¾¡
   */
  private getDefaultConcernEvaluation(concerns: string[]): Record<string, { score: number; summary: string; sources: string[] }> {
    const result: Record<string, { score: number; summary: string; sources: string[] }> = {};
    concerns.forEach(concern => {
      result[concern] = {
        score: 50,
        summary: 'æƒ…å ±ä¸è¶³ã®ãŸã‚è©•ä¾¡ã§ãã¾ã›ã‚“ã§ã—ãŸ',
        sources: []
      };
    });
    return result;
  }
  
  /**
   * ç›´æ¥çš„è©•ä¾¡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
   */
  private buildDirectEvaluationPrompt(companyName: string, concerns: string[]): string {
    return `ã‚ãªãŸã¯ä¼æ¥­è©•ä¾¡ã®å°‚é–€å®¶ã§ã™ã€‚
ä¼æ¥­ã€Œ${companyName}ã€ã«ã¤ã„ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ°—ã«ã—ã¦ã„ã‚‹ä»¥ä¸‹ã®è¦³ç‚¹ã§è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚

ã€è©•ä¾¡é …ç›®ã€‘
${concerns.map((c, i) => `${i + 1}. ${c}`).join('\n')}

ã€æŒ‡ç¤ºã€‘
- å„é …ç›®ã«ã¤ã„ã¦0-100ç‚¹ã§è©•ä¾¡ã—ã¦ãã ã•ã„
- è©•ä¾¡ã®æ ¹æ‹ ã¨ãªã‚‹å…¬é–‹æƒ…å ±ï¼ˆå£ã‚³ãƒŸã‚µã‚¤ãƒˆã€æŠ€è¡“ãƒ–ãƒ­ã‚°ã€SNSãªã©ï¼‰ãŒã‚ã‚Œã°æ˜ç¤ºã—ã¦ãã ã•ã„
- æƒ…å ±ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯50ç‚¹ã¨ã—ã¦ã€Œæƒ…å ±ä¸è¶³ã€ã¨è¨˜è¼‰ã—ã¦ãã ã•ã„
- æ¶ç©ºã®æƒ…å ±ã¯å«ã‚ãšã€ç¢ºèªã§ãã‚‹ç¯„å›²ã§è©•ä¾¡ã—ã¦ãã ã•ã„

ã€å‡ºåŠ›å½¢å¼ã€‘
å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

\`\`\`json
{
  "concerns": {
${concerns.map(c => `    "${c}": {
      "score": 0-100,
      "summary": "è©•ä¾¡ã®è¦ç´„ï¼ˆ1-2æ–‡ï¼‰",
      "sources": ["å‚ç…§å…ƒURL"]
    }`).join(',\n')}
  }
}
\`\`\`

é‡è¦: èª¬æ˜æ–‡ã¯ä¸è¦ã§ã™ã€‚JSONã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚`;
  }
  
  /**
   * æ‰¹åˆ¤çš„æ¤œè¨¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
   */
  private buildCriticalEvaluationPrompt(companyName: string, concerns: string[]): string {
    return `ã‚ãªãŸã¯æ…é‡ãªä¼æ¥­è©•ä¾¡ã®å°‚é–€å®¶ã§ã™ã€‚
ä¼æ¥­ã€Œ${companyName}ã€ã«ã¤ã„ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ°—ã«ã—ã¦ã„ã‚‹ä»¥ä¸‹ã®è¦³ç‚¹ã§æ‰¹åˆ¤çš„ã«æ¤œè¨¼ã—ã¦ãã ã•ã„ã€‚

ã€æ¤œè¨¼é …ç›®ã€‘
${concerns.map((c, i) => `${i + 1}. ${c}ã«é–¢ã™ã‚‹æ‡¸å¿µç‚¹ã‚„å•é¡ŒãŒãªã„ã‹`).join('\n')}

ã€æŒ‡ç¤ºã€‘
- å„é …ç›®ã«ã¤ã„ã¦ã€ãƒã‚¬ãƒ†ã‚£ãƒ–ãªæƒ…å ±ã‚„æ‡¸å¿µç‚¹ã‚’æ¢ã—ã¦ãã ã•ã„
- å•é¡ŒãŒã‚ã‚‹å ´åˆã¯ä½ã„ã‚¹ã‚³ã‚¢ï¼ˆ0-40ç‚¹ï¼‰ã‚’ã¤ã‘ã¦ãã ã•ã„
- å•é¡ŒãŒãªã„ã€ã¾ãŸã¯è‰¯å¥½ãªå ´åˆã¯é«˜ã„ã‚¹ã‚³ã‚¢ï¼ˆ60-100ç‚¹ï¼‰ã‚’ã¤ã‘ã¦ãã ã•ã„
- æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã¯50ç‚¹ã¨ã—ã¦ãã ã•ã„

ã€å‡ºåŠ›å½¢å¼ã€‘
å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

\`\`\`json
{
  "concerns": {
${concerns.map(c => `    "${c}": {
      "score": 0-100,
      "summary": "æ¤œè¨¼çµæœï¼ˆå•é¡Œç‚¹ã¾ãŸã¯è‰¯å¥½ãªç‚¹ï¼‰",
      "sources": []
    }`).join(',\n')}
  }
}
\`\`\`

é‡è¦: èª¬æ˜æ–‡ã¯ä¸è¦ã§ã™ã€‚JSONã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚`;
  }

  /**
   * ä¼æ¥­è©•ä¾¡ï¼ˆæ—¢å­˜å®Ÿè£…ï¼‰
   */
  async evaluateCompany(companyId: string, companyName: string): Promise<CompanyEvaluation> {
    const prompt = this.buildCompanyEvaluationPrompt(companyName);
    
    try {
      const response = await this.generateContentWithRetry(prompt, 0.3, 2048);

      if (!response.ok) {
        const errorText = await response.text();
        console.error(`Gemini API Error Detail: ${errorText}`);
        throw new Error(`Gemini API error: ${response.statusText} (${response.status})`);
      }

      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '{}';
      
      const jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```/) || text.match(/\{[\s\S]*\}/);
      const jsonText = jsonMatch ? (jsonMatch[1] || jsonMatch[0]) : '{}';
      
      const parsed = JSON.parse(jsonText);
      
      return {
        summary: parsed.summary || 'æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚',
        topics: parsed.topics || [],
        generated_at: new Date().toISOString(),
      };
    } catch (error: any) {
      if (error.message?.includes('(429)')) {
        console.warn('[Gemini] Rate limit exceeded. Cannot evaluate company at this time.');
      } else {
        console.error('Failed to evaluate company:', error);
      }
      return {
        summary: 'ç¾åœ¨ã€ã‚¢ã‚¯ã‚»ã‚¹é›†ä¸­ã«ã‚ˆã‚Šä¼æ¥­è©•ä¾¡ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã€‚',
        topics: [],
        generated_at: new Date().toISOString(),
      };
    }
  }

  // ========== ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ ==========

  /**
   * Chain-of-Thought ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
   */
  private buildCoTPrompt(query: string): string {
    return `ã‚ãªãŸã¯å„ªç§€ãªITã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ±‚äººæ¤œç´¢ã‚¯ã‚¨ãƒªã‚’æ·±ãåˆ†æã—ã€æ˜ç¤ºçš„ãªæ¡ä»¶ã¨æš—é»™çš„ãªå¸Œæœ›ã®ä¸¡æ–¹ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã€‘
${query}

ã€é‡è¦ãªæ³¨æ„äº‹é …ã€‘
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªç„¶æ–‡ã¨æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ï¼ˆæŠ€è¡“åã€åœ°åã€æ•°å€¤ï¼‰ã‚’çµ„ã¿åˆã‚ã›ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
- ã€ŒReactã€TypeScriptã€ã®ã‚ˆã†ãªã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®ãƒªã‚¹ãƒˆã‚‚æ­£ã—ãè§£é‡ˆã—ã¦ãã ã•ã„
- ã€Œæ±äº¬ã¾ãŸã¯å¤§é˜ªã€ã®ã‚ˆã†ãªé¸æŠè‚¢ã‚‚é…åˆ—ã¨ã—ã¦æŠ½å‡ºã—ã¦ãã ã•ã„
- ã€Œå¹´å800ä¸‡å††ä»¥ä¸Šã€ã®ã‚ˆã†ãªæ•°å€¤æ¡ä»¶ã‚‚æ­£ç¢ºã«æŠ½å‡ºã—ã¦ãã ã•ã„
- ã€ŒãŸã ã—ã€œã¯é™¤å¤–ã€ã®ã‚ˆã†ãªé™¤å¤–æ¡ä»¶ã«ã‚‚æ³¨æ„ã—ã¦ãã ã•ã„

ã€åˆ†æã‚¿ã‚¹ã‚¯ã€‘
1. ã¾ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ˜ç¤ºçš„ã«è¿°ã¹ã¦ã„ã‚‹æ¡ä»¶ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„
   - å‹¤å‹™åœ°: å…·ä½“çš„ãªåœ°åï¼ˆã€Œå‹¤å‹™åœ°ã¯æ±äº¬ã€â†’ ["æ±äº¬"]ï¼‰
   - ã‚¹ã‚­ãƒ«: æŠ€è¡“åã€è¨€èªåã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯åï¼ˆã€ŒReactã€TypeScriptã€â†’ ["React", "TypeScript"]ï¼‰
   - å¹´å: æ•°å€¤ã§æŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆã€Œå¹´å800ä¸‡å††ä»¥ä¸Šã€â†’ 8000000ï¼‰
   - åƒãæ–¹: ãƒªãƒ¢ãƒ¼ãƒˆã€ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ãªã©ï¼ˆã€Œåƒãæ–¹ã¯ãƒªãƒ¢ãƒ¼ãƒˆã€â†’ ["ãƒªãƒ¢ãƒ¼ãƒˆ"]ï¼‰
   
2. æ¬¡ã«ã€æ–‡è„ˆã‹ã‚‰æ¨æ¸¬ã§ãã‚‹æš—é»™ã®å¸Œæœ›ã‚’æ¨è«–ã—ã¦ãã ã•ã„
   ä¾‹: 
   - "æ®‹æ¥­ãŒå°‘ãªã„" â†’ must_have: ["ãƒ¯ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ•ãƒãƒ©ãƒ³ã‚¹"]
   - "ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—" â†’ company_size: ["Startup"]
   - "ReactçµŒé¨“è€…" â†’ role: "Frontend Engineer", min_salary: 6000000ï¼ˆæ¨æ¸¬ï¼‰
   
3. é™¤å¤–æ¡ä»¶ãŒã‚ã‚Œã°æŠ½å‡ºã—ã¦ãã ã•ã„
   ä¾‹: "ãŸã ã—SESã¯é™¤å¤–" â†’ exclude: ["SES"]

4. æœ€å¾Œã«ã€æ¤œç´¢æ„å›³ã‚’1æ–‡ã§è¦ç´„ã—ã¦ãã ã•ã„

ã€å‡ºåŠ›å½¢å¼ã€‘
JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚„èª¬æ˜æ–‡ã¯ä¸€åˆ‡ä¸è¦ã§ã™ã€‚

{
  "explicit": {
    "locations": ["å‹¤å‹™åœ°ã®é…åˆ—"],
    "skills": ["ã‚¹ã‚­ãƒ«ã®é…åˆ—"],
    "min_salary": æ•°å€¤ã¾ãŸã¯null
  },
  "implicit": {
    "role": "æ¨æ¸¬ã•ã‚Œã‚‹è·ç¨®",
    "employment_type": ["æ­£ç¤¾å“¡ãªã©"],
    "min_salary": null,
    "company_size": ["Startup", "Enterprise", "SME"],
    "nice_to_have": ["ã‚ã‚Œã°å¬‰ã—ã„æ¡ä»¶"],
    "must_have": ["å¿…é ˆæ¡ä»¶"]
  },
  "exclude": ["é™¤å¤–ã™ã‚‹æ¡ä»¶"],
  "search_intent_summary": "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¤œç´¢æ„å›³ã‚’1æ–‡ã§è¦ç´„"
}

ã€å‡ºåŠ›åˆ¶ç´„ - å³å®ˆã€‘
- JSONã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„
- ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®å›²ã„ï¼ˆ\`\`\`jsonï¼‰ã¯ä¸è¦ã§ã™
- èª¬æ˜æ–‡ã€å‰ç½®ãã€å¾Œç½®ãã€ã‚³ãƒ¡ãƒ³ãƒˆã¯ä¸€åˆ‡ä¸è¦ã§ã™
- æ¨æ¸¬ã§ããªã„é …ç›®ã¯nullã¾ãŸã¯ç©ºé…åˆ—ã«ã—ã¦ãã ã•ã„
- æ¶ç©ºã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½œã‚‰ãªã„ã§ãã ã•ã„`;
  }

  private buildSearchQueryPrompt(query: string): string {
    return `ã‚ãªãŸã¯å„ªç§€ãªITå°‚é–€ã®æ¡ç”¨æ‹…å½“è€…å…¼ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒŠãƒªã‚¹ãƒˆã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ›–æ˜§ãªè¦æœ›ã‹ã‚‰ã€å…·ä½“çš„ãªæ¤œç´¢æ¡ä»¶ã‚’æ¨è«–ãƒ»æŠ½å‡ºã™ã‚‹ã“ã¨ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚

ä»¥ä¸‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’è§£æã—ã€JSONå½¢å¼ã§æ¤œç´¢æ¡ä»¶ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
æ¨è«–ã§ããªã„é …ç›®ã¯ null ã¾ãŸã¯ç©ºé…åˆ—ã¨ã—ã¦ãã ã•ã„ã€‚å˜˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã€‘
${query}

ã€å‡ºåŠ›ã‚¹ã‚­ãƒ¼ãƒã€‘
\`\`\`json
{
  "keywords": [],
  "locations": [],
  "min_salary": null,
  "max_salary": null,
  "skills": [],
  "employment_type": [],
  "remote_available": null,
  "experience_level": [],
  "company_characteristics": []
}
\`\`\`

å‡ºåŠ›ã¯ä¸Šè¨˜ã®JSONå½¢å¼ã®ã¿ã¨ã—ã€èª¬æ˜æ–‡ã¯ä¸è¦ã§ã™ã€‚`;
  }

  private buildCompanyEvaluationPrompt(companyName: string): string {
    return `ã‚ãªãŸã¯ä¼æ¥­è©•ä¾¡ã®å°‚é–€å®¶ã§ã™ã€‚
ä»¥ä¸‹ã®ä¼æ¥­ã«ã¤ã„ã¦ã€å®¢è¦³çš„ãªè©•ä¾¡ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

ä¼æ¥­å: ${companyName}

ä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

\`\`\`json
{
  "summary": "ä¼æ¥­ã®ç·åˆçš„ãªè©•ä¾¡ï¼ˆ1ã€œ2æ–‡ï¼‰",
  "topics": [
    {
      "category": "Culture",
      "title": "ãƒˆãƒ”ãƒƒã‚¯ã®ã‚¿ã‚¤ãƒˆãƒ«",
      "description": "è©³ç´°ãªèª¬æ˜",
      "sentiment": "Positive",
      "sources": [
        { "title": "æƒ…å ±æºã®ã‚¿ã‚¤ãƒˆãƒ«", "url": "https://example.com" }
      ]
    }
  ]
}
\`\`\`

é‡è¦ãªæ³¨æ„äº‹é …:
1. å¿…ãšæ ¹æ‹ ã¨ãªã‚‹æƒ…å ±æºï¼ˆsourcesï¼‰ã‚’å«ã‚ã‚‹ã“ã¨
2. æ¨æ¸¬ã‚„æ¶ç©ºã®æƒ…å ±ã¯å«ã‚ãªã„ã“ã¨
3. å„ãƒˆãƒ”ãƒƒã‚¯ã¯Positive/Negative/Neutralã‚’æ˜ç¢ºã«ã™ã‚‹ã“ã¨

å‡ºåŠ›ã¯ä¸Šè¨˜ã®JSONå½¢å¼ã®ã¿ã¨ã—ã€èª¬æ˜æ–‡ã¯ä¸è¦ã§ã™ã€‚`;
  }

  /**
   * ãƒªãƒˆãƒ©ã‚¤ä»˜ãã§Gemini APIã‚’å‘¼ã³å‡ºã™
   * 429ã‚¨ãƒ©ãƒ¼æ™‚ã¯æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§ãƒªãƒˆãƒ©ã‚¤
   */
  private async generateContentWithRetry(
    prompt: string, 
    temperature: number, 
    maxOutputTokens: number,
    useGrounding: boolean = false
  ): Promise<Response> {
    const models = [
      'models/gemini-2.5-flash-lite',  // æœ€è»½é‡ãƒ»æœ€é€Ÿï¼ˆå„ªå…ˆï¼‰
      'models/gemini-2.5-flash',       // æ¨™æº–ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯1ï¼‰
      'models/gemini-3-flash'          // æœ€æ–°ä¸–ä»£ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯2ï¼‰
    ];
    const maxRetries = 2; // ç„¡æ–™æ ã®1æ—¥ã‚ãŸã‚Šåˆ¶é™ã‚’è€ƒæ…®ã—ã€ãƒªãƒˆãƒ©ã‚¤å›æ•°ã‚’å‰Šæ¸›
    let lastError: any = null;

    for (const model of models) {
      for (let attempt = 0; attempt <= maxRetries; attempt++) {
        try {
          console.log(`[Gemini] Trying model: ${model} (attempt ${attempt + 1}/${maxRetries + 1})`);
          
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 15000); // 15ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã«çŸ­ç¸®

          try {
            const response = await fetch(
              `${this.baseUrl}/${model}:generateContent?key=${this.apiKey}`,
              {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  contents: [{
                    parts: [{ text: prompt }]
                  }],
                  tools: useGrounding ? [{
                    googleSearch: {}
                  }] : [],
                  generationConfig: {
                    temperature,
                    topP: 0.8,
                    maxOutputTokens,
                  },
                }),
                signal: controller.signal,
              }
            );
            clearTimeout(timeoutId);

            if (response.ok) {
              return response;
            }

            // 429 Rate Limit: æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§ãƒªãƒˆãƒ©ã‚¤
            if (response.status === 429) {
              const waitTime = Math.pow(2, attempt) * 5000; // 5ç§’, 10ç§’... (é–“éš”ã‚’åºƒã’ã¦å›æ•°ã‚’æ¸›ã‚‰ã™)
              console.warn(`â³ [Gemini] Rate limit (429). ${waitTime/1000}ç§’å¾Œã«ãƒªãƒˆãƒ©ã‚¤...`);
              await this.sleep(waitTime);
              continue; // åŒã˜ãƒ¢ãƒ‡ãƒ«ã§ãƒªãƒˆãƒ©ã‚¤
            }

            // 500, 503: ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ - æ¬¡ã®ãƒ¢ãƒ‡ãƒ«ã¸
            if ([500, 503, 404].includes(response.status)) {
              console.warn(`[Gemini] Model ${model} failed with status ${response.status}. Trying next model...`);
              lastError = response;
              break; // æ¬¡ã®ãƒ¢ãƒ‡ãƒ«ã¸
            }
            
            // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã¯ãã®ã¾ã¾è¿”ã™
            return response;

          } catch (fetchError: any) {
            clearTimeout(timeoutId);
            if (fetchError.name === 'AbortError') {
              console.warn(`[Gemini] Timeout with model ${model}. Trying next model...`);
              lastError = new Error(`Timeout with model ${model}`);
              break; // æ¬¡ã®ãƒ¢ãƒ‡ãƒ«ã¸
            } else {
              throw fetchError;
            }
          }

        } catch (error) {
          console.warn(`[Gemini] Network error with model ${model}. Retrying...`, error);
          lastError = error;
        }
      }
    }

    if (lastError instanceof Response) {
      return lastError;
    }
    throw lastError || new Error('All models failed');
  }

  /**
   * æŒ‡å®šãƒŸãƒªç§’å¾…æ©Ÿ
   */
  private sleep(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  /**
   * Stage 3+4: çµ±åˆæ¤œè¨¼ï¼ˆSelf-Consistency + ä¼æ¥­è©•ä¾¡ï¼‰
   * æ±‚äººå†…å®¹ã¨ä¼æ¥­è©•ä¾¡ã‚’åŒæ™‚ã«è©•ä¾¡ã—ã€å¤šæ•°æ±ºã§ä¿¡é ¼æ€§ã‚’ç¢ºä¿
   */
  async evaluateJobsWithCompanies(
    candidates: any[],
    intent: SearchIntent
  ): Promise<JobWithCompanyEvaluation[]> {
    console.log('\n========================================');
    console.log('ğŸ” [Stage 3+4] çµ±åˆæ¤œè¨¼ï¼ˆSelf-Consistency + ä¼æ¥­è©•ä¾¡ï¼‰');
    console.log('========================================');
    console.log(`ğŸ“‹ å€™è£œæ•°: ${candidates.length}ä»¶`);
    
    const validatedJobs: JobWithCompanyEvaluation[] = [];
    
    for (const job of candidates) {
      try {
        console.log(`\nè©•ä¾¡ä¸­: ${job.title} @ ${job.company?.name}`);
        
        // åŒã˜ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’3å›å®Ÿè¡Œï¼ˆSelf-Consistencyï¼‰
        const prompt = this.buildIntegratedEvaluationPrompt(job, intent);
        
        const evaluations = await Promise.all([
          this.evaluateJobSingle(prompt),
          this.evaluateJobSingle(prompt),
          this.evaluateJobSingle(prompt)
        ]);
        
        // å„è©•ä¾¡ã‹ã‚‰çµæœã‚’æŠ½å‡º
        const results: IntegratedEvaluationResult[] = evaluations.map(e => this.parseIntegratedEvaluationResult(e));
        
        // å¤šæ•°æ±º: 3å›ä¸­2å›ä»¥ä¸Šã€Œrecommend: trueã€ãªã‚‰æ¡ç”¨
        const recommendCount = results.filter(r => r.recommend).length;
        
        console.log(`  æ¨è–¦åˆ¤å®š: ${recommendCount}/3å›`);
        
        if (recommendCount >= 2) {
          // ã‚¹ã‚³ã‚¢ã‚’å¹³å‡åŒ–
          const avgJobMatchScore = Math.round(
            results.reduce((sum, r) => sum + r.job_match_score, 0) / results.length
          );
          
          const avgOverallScore = Math.round(
            results.reduce((sum, r) => sum + r.overall_score, 0) / results.length
          );
          
          // ä¼æ¥­è©•ä¾¡ã‚’çµ±åˆ
          const companyEvaluation = this.mergeCompanyEvaluations(results);
          
          validatedJobs.push({
            ...job,
            job_match_score: avgJobMatchScore,
            company_evaluation: companyEvaluation,
            overall_score: avgOverallScore,
            confidence: recommendCount === 3 ? 100 : 67
          });
          
          console.log(`  âœ… æ¡ç”¨ (ä¿¡é ¼åº¦: ${recommendCount === 3 ? 100 : 67}%)`);
        } else {
          console.log(`  âŒ ä¸æ¡ç”¨ï¼ˆæ¨è–¦ãŒéåŠæ•°æœªæº€ï¼‰`);
        }
        
        // ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–: 3ç§’å¾…æ©Ÿ
        await this.sleep(3000);
        
      } catch (error) {
        console.error(`è©•ä¾¡ã‚¨ãƒ©ãƒ¼: ${job.title}`, error);
        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚æ¬¡ã®æ±‚äººã®è©•ä¾¡ã‚’ç¶šã‘ã‚‹
      }
    }
    
    console.log(`\næœ€çµ‚çµæœ: ${validatedJobs.length}/${candidates.length}ä»¶ãŒæ¡ç”¨ã•ã‚Œã¾ã—ãŸ`);
    return validatedJobs;
  }

  /**
   * 1å›åˆ†ã®è©•ä¾¡ã‚’å®Ÿè¡Œ
   */
  private async evaluateJobSingle(prompt: string): Promise<string> {
    const response = await this.generateContentWithRetry(prompt, 0.5, 1536);
    
    if (!response.ok) {
      throw new Error(`Gemini API error: ${response.statusText}`);
    }
    
    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || '{}';
  }

  /**
   * çµ±åˆè©•ä¾¡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
   */
  private buildIntegratedEvaluationPrompt(job: any, intent: SearchIntent): string {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢å¿ƒäº‹é …ã‚’æŠ½å‡º
    const concerns = this.extractUserConcerns(intent);
    
    return `ã“ã®æ±‚äººã‚’ã€ä¼æ¥­ã®è©•åˆ¤ã‚‚å«ã‚ã¦ç·åˆçš„ã«è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¤œç´¢æ„å›³ã€‘
${intent.search_intent_summary}

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é–¢å¿ƒäº‹é …ã€‘
${concerns.join(', ')}

ã€æ±‚äººæƒ…å ±ã€‘
ä¼æ¥­: ${job.company?.name || 'ä¸æ˜'}
è·ç¨®: ${job.title}
ã‚¹ã‚­ãƒ«: ${job.skills?.join(', ') || 'ä¸æ˜'}
å¹´å: ${job.salary_min || 'ä¸æ˜'} - ${job.salary_max || 'ä¸æ˜'}
å‹¤å‹™åœ°: ${job.location}

ã€è©•ä¾¡é …ç›®ã€‘
1. æ±‚äººå†…å®¹ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¡ä»¶ã«åˆè‡´ã—ã¦ã„ã‚‹ã‹ï¼ˆ0-100ï¼‰
2. ä¼æ¥­ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é–¢å¿ƒäº‹é …ã«ã¤ã„ã¦è‰¯å¥½ã‹ï¼ˆ0-100ï¼‰
3. ç·åˆçš„ã«æ¨è–¦ã§ãã‚‹ã‹ï¼ˆtrue/falseï¼‰

ã€å‡ºåŠ›å½¢å¼ã€‘
JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
{
  "job_match_score": 85,
  "company_concerns": {
${concerns.slice(0, 5).map(c => `    "${c}": { "score": 80, "summary": "..." }`).join(',\n')}
  },
  "overall_score": 84,
  "recommend": true
}

ã€å‡ºåŠ›åˆ¶ç´„ - å³å®ˆã€‘
- JSONã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„
- ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®å›²ã„ã¯ä¸è¦ã§ã™
- èª¬æ˜æ–‡ã€å‰ç½®ãã€å¾Œç½®ãã¯ä¸€åˆ‡ä¸è¦ã§ã™`;
  }

  /**
   * è©•ä¾¡çµæœã‚’ãƒ‘ãƒ¼ã‚¹
   */
  private parseIntegratedEvaluationResult(text: string): IntegratedEvaluationResult {
    try {
      // JSONã‚’æŠ½å‡º
      const jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```/) || text.match(/\{[\s\S]*\}/);
      const jsonText = jsonMatch ? (jsonMatch[1] || jsonMatch[0]) : text;
      
      const parsed = JSON.parse(jsonText);
      
      return {
        job_match_score: parsed.job_match_score || 50,
        company_concerns: parsed.company_concerns || {},
        overall_score: parsed.overall_score || 50,
        recommend: parsed.recommend !== undefined ? parsed.recommend : false
      };
    } catch (error) {
      console.error('JSON parse error:', error);
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
      return {
        job_match_score: 50,
        company_concerns: {},
        overall_score: 50,
        recommend: false
      };
    }
  }

  /**
   * 3å›ã®è©•ä¾¡çµæœã‹ã‚‰ä¼æ¥­è©•ä¾¡ã‚’çµ±åˆ
   */
  private mergeCompanyEvaluations(results: IntegratedEvaluationResult[]): {
    concerns: Record<string, ConcernScore>;
    overall_score: number;
  } {
    const allConcerns: Record<string, Array<{ score: number; summary: string }>> = {};
    
    // å„è©•ä¾¡çµæœã‹ã‚‰é–¢å¿ƒäº‹é …ã‚’é›†ç´„
    results.forEach(result => {
      Object.entries(result.company_concerns).forEach(([concern, data]) => {
        if (!allConcerns[concern]) {
          allConcerns[concern] = [];
        }
        allConcerns[concern].push(data);
      });
    });
    
    // å¹³å‡å€¤ã‚’ç®—å‡º
    const concerns: Record<string, ConcernScore> = {};
    Object.entries(allConcerns).forEach(([concern, scores]) => {
      const avgScore = Math.round(
        scores.reduce((sum, s) => sum + s.score, 0) / scores.length
      );
      
      concerns[concern] = {
        concern,
        score: avgScore,
        summary: scores[0]?.summary || 'è©•ä¾¡æƒ…å ±ãªã—',
        sources: []
      };
    });
    
    // å…¨ä½“ã®å¹³å‡ã‚¹ã‚³ã‚¢
    const overall_score = Object.keys(concerns).length > 0
      ? Math.round(
          Object.values(concerns).reduce((sum, c) => sum + c.score, 0) / Object.keys(concerns).length
        )
      : 50;
    
    return {
      concerns,
      overall_score
    };
  }
}
